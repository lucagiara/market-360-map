<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Market Street 360 Survey Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- EXIF GPS reader -->
  <script src="https://unpkg.com/exifr@7.1.3/dist/lite.umd.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #top {
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      background: #f8f8f8;
    }
    #titleRow { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1 { font-size: 18px; margin: 0; }
    .hint { font-size: 12px; color: #444; margin-top: 6px; }

    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top: 8px; }
    .row label { font-size: 12px; color: #333; }
    input[type="text"] { padding: 6px 8px; border: 1px solid #bbb; border-radius: 6px; min-width: 320px; }
    button { padding: 7px 10px; border: 1px solid #888; border-radius: 8px; background:#fff; cursor:pointer; }
    button:hover { background:#f1f1f1; }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; background:#fff; border:1px solid #ddd; color:#333; }

    #map { height: calc(100% - 140px); }
    @media (max-width: 900px) {
      #map { height: calc(100% - 190px); }
      input[type="text"] { min-width: 220px; width: 100%; }
    }

    .popup-title { font-weight: 700; margin-bottom: 6px; }
    .popup-note { font-size: 12px; color: #444; margin: 6px 0; }
    .popup-img { width: 240px; max-width: 100%; border-radius: 10px; display:block; margin-top: 8px; }
    .popup-actions { margin-top: 8px; display:flex; gap:12px; flex-wrap: wrap; }
    .popup-actions a { color: #0b66c3; text-decoration: none; font-size: 13px; }
    .popup-actions a:hover { text-decoration: underline; }

    .status { font-size: 12px; color: #222; }
  </style>
</head>

<body>
  <div id="top">
    <div id="titleRow">
      <h1>Market Street 360 Survey Map</h1>
      <span class="pill" id="modePill">Ready</span>
    </div>

    <div class="hint">
      GitHub mode: images must exist in <b>./photos/</b> for hosted preview. Your pins publish when you Export â†’ replace <b>pins.json</b> in the repo â†’ commit.
    </div>

    <div class="row">
      <button id="reloadBtn">Reload pins.json</button>
      <button id="exportBtn">Export pins.json</button>
      <button id="importBtn">Import pins.json</button>
      <button id="clearBtn">Clear local pins</button>
      <span class="status" id="status">Loadingâ€¦</span>
    </div>

    <div class="row">
      <label>Author mode:</label>
      <input id="fileInput" type="file" accept="image/jpeg,image/jpg" multiple />
      <span class="hint">Select JPGs. GPS photos auto-pin. No-GPS photos will ask you to click the map to place them.</span>
    </div>
  </div>

  <div id="map"></div>

<script>
  // -------------------------
  // Config
  // -------------------------
  const PHOTOS_BASE = "photos/";     // your repo folder
  const PINS_JSON_URL = "pins.json"; // in repo root

  // -------------------------
  // Map + optional satellite toggle
  // -------------------------
  const map = L.map("map", { zoomControl: true }).setView([37.7895, -122.401], 17);

  const baseLight = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
    { attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }
  ).addTo(map);

  const sat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { attribution: "Tiles &copy; Esri" }
  );

  L.control.layers(
    { "Map (default)": baseLight, "Satellite": sat },
    {},
    { collapsed: true }
  ).addTo(map);

  // -------------------------
  // State
  // -------------------------
  const statusEl = document.getElementById("status");
  const modePill = document.getElementById("modePill");
  const fileInput = document.getElementById("fileInput");

  const reloadBtn = document.getElementById("reloadBtn");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const clearBtn = document.getElementById("clearBtn");

  const importInput = document.createElement("input");
  importInput.type = "file";
  importInput.accept = "application/json";
  importInput.style.display = "none";
  document.body.appendChild(importInput);

  let pinData = [];
  let mode = null;                  // {type:"place", draft:{...}} or {type:"edit", pinId:"..."}
  let manualQueue = [];
  const markerById = new Map();

  const previewUrlByHosted = new Map(); // hostedUrl -> blobUrl
  const panoByHosted = new Map();       // hostedUrl -> boolean
  let sessionObjectUrls = [];

  // -------------------------
  // Helpers
  // -------------------------
  function setMode(m) {
    mode = m;

    const container = map.getContainer();

    if (!mode) {
      modePill.textContent = "Ready";
      container.style.cursor = "grab";
      map.dragging.enable();
      map.doubleClickZoom.enable();
      return;
    }

    if (mode.type === "place") {
      modePill.textContent = "Place pin: click map";
      container.style.cursor = "crosshair"; // ðŸŽ¯
      map.dragging.disable();
      map.doubleClickZoom.disable();
      return;
    }

    if (mode.type === "edit") {
      modePill.textContent = "Edit pin: click map";
      container.style.cursor = "crosshair"; // ðŸŽ¯
      map.dragging.disable();
      map.doubleClickZoom.disable();
      return;
    }
  }

  function uid() {
    return "p_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
  }

  function saveLocal() {
    localStorage.setItem("market360_local_pins_v1", JSON.stringify(pinData));
  }

  function loadLocal() {
    try {
      const raw = localStorage.getItem("market360_local_pins_v1");
      if (!raw) return false;
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return false;
      pinData = arr;
      return true;
    } catch {
      return false;
    }
  }

  function clearSessionPreviews() {
    for (const u of sessionObjectUrls) {
      try { URL.revokeObjectURL(u); } catch {}
    }
    sessionObjectUrls = [];
    previewUrlByHosted.clear();
    panoByHosted.clear();
  }

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function is360ForPin(pin) {
    if (pin && pin.is360 === true) return true;
    if (pin && pin.url && panoByHosted.get(pin.url) === true) return true;
    return false;
  }

  function detectPanorama(blobUrl) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const w = img.naturalWidth || img.width;
        const h = img.naturalHeight || img.height;
        if (!w || !h) return resolve(false);
        const r = w / h;
        resolve(r > 1.85 && r < 2.15);
      };
      img.onerror = () => resolve(false);
      img.src = blobUrl;
    });
  }

  function removeAllMarkers() {
    for (const m of markerById.values()) {
      try { map.removeLayer(m); } catch {}
    }
    markerById.clear();
  }

  // -------------------------
  // Popup HTML
  // -------------------------
  function buildPopupHtml(pin) {
    const title = escapeHtml(pin.title || pin.fileName || "Photo");
    const url = pin.url ? String(pin.url) : "";
    const safeUrl = escapeHtml(url);
    const hasUrl = !!url;

    const localPreview = hasUrl ? previewUrlByHosted.get(url) : null;
    const imgSrc = localPreview || (hasUrl ? url : "");

    const pano = is360ForPin(pin);
    const viewerUrl = "viewer.html?img=" + encodeURIComponent(url) + "&title=" + encodeURIComponent(title);

    const note = !imgSrc ? `
      <div class="popup-note">No preview available.</div>
    ` : (!localPreview ? `
      <div class="popup-note">
        If you see 404, the image is missing in <b>/photos/</b> or the filename case/extension differs (JPG vs jpg).
      </div>
    ` : `
      <div class="popup-note">Local preview (this session). Hosted path: <b>${safeUrl}</b></div>
    `);

    const imgTag = imgSrc ? `<img class="popup-img" src="${escapeHtml(imgSrc)}" alt="${title}" />` : "";

    const actions = `
      <div class="popup-actions">
        ${pano && url ? `<a href="${viewerUrl}" target="_blank" rel="noopener">Open 360 viewer (new tab)</a>` : ""}
        ${url ? `<a href="${safeUrl}" target="_blank" rel="noopener">Open raw image</a>` : ""}
        <a href="#" data-action="edit" data-id="${escapeHtml(pin.id)}">Edit location</a>
      </div>
    `;

    const panoLabel = pano ? `<div class="popup-note"><b>Detected/marked as 360 panorama.</b></div>` : "";

    return `
      <div class="popup-title">${title}</div>
      ${note}
      ${imgTag}
      ${panoLabel}
      ${actions}
    `;
  }

  // -------------------------
  // Markers (DRAGGABLE)
  // -------------------------
  function addOrUpdateMarker(pin) {
    const html = buildPopupHtml(pin);
    const existing = markerById.get(pin.id);
    if (existing) {
      existing.setLatLng([pin.lat, pin.lng]);
      existing.setPopupContent(html);
      return existing;
    }

    const m = L.marker([pin.lat, pin.lng], { draggable: true })
      .addTo(map)
      .bindPopup(html);

    // âœ… Dragging always updates stored location (GPS pins + manual pins)
    m.on("dragend", () => {
      const ll = m.getLatLng();
      const idx = pinData.findIndex(p => p.id === pin.id);
      if (idx >= 0) {
        pinData[idx].lat = ll.lat;
        pinData[idx].lng = ll.lng;
        saveLocal();
        m.setPopupContent(buildPopupHtml(pinData[idx]));
      }
    });

    markerById.set(pin.id, m);
    return m;
  }

  function renderAllPins(fit = false) {
    removeAllMarkers();
    for (const p of pinData) {
      if (!p || typeof p.lat !== "number" || typeof p.lng !== "number") continue;
      addOrUpdateMarker(p);
    }
    statusEl.textContent = `${pinData.length} pin(s) loaded`;
    if (fit && pinData.length) {
      const group = L.featureGroup([...markerById.values()]);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  }

  // -------------------------
  // Manual queue for no-GPS photos
  // -------------------------
  function startManualQueue(queue) {
    manualQueue = queue.slice();
    if (!manualQueue.length) {
      setMode(null);
      return;
    }
    const next = manualQueue.shift();
    setMode({ type: "place", draft: next });
    statusEl.textContent = `No GPS: click map to place "${next.fileName}" (${manualQueue.length + 1} remaining)`;
  }

  function continueManualQueue() {
    if (!manualQueue.length) {
      setMode(null);
      statusEl.textContent = "Manual placement complete.";
      return;
    }
    const next = manualQueue.shift();
    setMode({ type: "place", draft: next });
    statusEl.textContent = `No GPS: click map to place "${next.fileName}" (${manualQueue.length + 1} remaining)`;
  }

  // -------------------------
  // "Edit location" link handler
  // -------------------------
  document.addEventListener("click", (evt) => {
    const a = evt.target.closest ? evt.target.closest("[data-action]") : null;
    if (!a) return;
    const action = a.getAttribute("data-action");
    if (action === "edit") {
      evt.preventDefault();
      evt.stopPropagation();
      const id = a.getAttribute("data-id");
      if (!id) return;
      manualQueue = [];
      setMode({ type: "edit", pinId: id });
      statusEl.textContent = "Click map to set new locationâ€¦";
    }
  });

  // -------------------------
  // Map click to place/edit
  // -------------------------
  map.on("click", (evt) => {
    if (!mode) return;
    const lat = evt.latlng.lat;
    const lng = evt.latlng.lng;

    if (mode.type === "place") {
      const d = mode.draft;
      if (!d || !d.url) { setMode(null); return; }
      const pin = {
        id: uid(),
        lat, lng,
        url: d.url,
        title: d.title || "",
        fileName: d.fileName || "",
        is360: d.is360 === true,
        ts: Date.now()
      };
      pinData.push(pin);
      saveLocal();
      renderAllPins(false);
      markerById.get(pin.id)?.openPopup();
      setMode(null);
      map.setView([lat, lng], Math.max(map.getZoom(), 18));
      if (manualQueue.length) continueManualQueue();
      return;
    }

    if (mode.type === "edit") {
      const idx = pinData.findIndex(p => p.id === mode.pinId);
      if (idx < 0) { setMode(null); return; }
      pinData[idx].lat = lat;
      pinData[idx].lng = lng;
      saveLocal();
      renderAllPins(false);
      markerById.get(pinData[idx].id)?.openPopup();
      setMode(null);
      map.setView([lat, lng], Math.max(map.getZoom(), 18));
    }
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      manualQueue = [];
      setMode(null);
      statusEl.textContent = "Cancelled.";
    }
  });

  // -------------------------
  // Load pins.json OR local draft
  // -------------------------
  async function loadFromPinsJson() {
    try {
      const res = await fetch(PINS_JSON_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("pins.json not found");
      const arr = await res.json();
      if (!Array.isArray(arr)) throw new Error("pins.json invalid");

      pinData = arr
        .filter(p => p && typeof p.lat === "number" && typeof p.lng === "number" && p.url)
        .map(p => ({
          id: String(p.id || uid()),
          lat: p.lat,
          lng: p.lng,
          url: String(p.url),
          title: p.title ? String(p.title) : "",
          fileName: p.fileName ? String(p.fileName) : (String(p.url).split("/").pop() || ""),
          is360: p.is360 === true,
          ts: p.ts || Date.now()
        }));

      saveLocal();
      renderAllPins(true);
      statusEl.textContent = `${pinData.length} pin(s) loaded`;
    } catch (e) {
      const ok = loadLocal();
      renderAllPins(true);
      statusEl.textContent = ok ? `${pinData.length} pin(s) loaded (local draft)` : "No pins loaded yet";
    }
  }

  // -------------------------
  // Buttons
  // -------------------------
  reloadBtn.addEventListener("click", async () => {
    await loadFromPinsJson();
  });

  exportBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(pinData, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pins.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    alert('Exported pins.json.\n\nTo publish on GitHub Pages:\n1) Upload your images into /photos/\n2) Replace pins.json in the repo with this exported file\n3) Commit + Push');
  });

  importBtn.addEventListener("click", () => importInput.click());

  importInput.addEventListener("change", async (e) => {
    const f = e.target.files[0];
    if (!f) return;
    try {
      const txt = await f.text();
      const arr = JSON.parse(txt);
      if (!Array.isArray(arr)) throw new Error("bad");

      pinData = arr
        .filter(p => p && typeof p.lat === "number" && typeof p.lng === "number" && p.url)
        .map(p => ({
          id: String(p.id || uid()),
          lat: p.lat,
          lng: p.lng,
          url: String(p.url),
          title: p.title ? String(p.title) : "",
          fileName: p.fileName ? String(p.fileName) : (String(p.url).split("/").pop() || ""),
          is360: p.is360 === true,
          ts: p.ts || Date.now()
        }));

      saveLocal();
      renderAllPins(true);
      statusEl.textContent = `Imported ${pinData.length} pin(s)`;
    } catch {
      alert("Could not import JSON.");
    } finally {
      importInput.value = "";
    }
  });

  clearBtn.addEventListener("click", () => {
    if (!confirm("Clear local pins + local previews?")) return;
    clearSessionPreviews();
    pinData = [];
    saveLocal();
    removeAllMarkers();
    setMode(null);
    statusEl.textContent = "No pins loaded yet";
    fileInput.value = "";
  });

  // -------------------------
  // Choose Files
  // GPS => auto pin
  // No GPS => queue -> click map to place
  // -------------------------
  fileInput.addEventListener("change", async (event) => {
    const files = Array.from(event.target.files || []);
    if (!files.length) return;

    clearSessionPreviews();

    let addedGps = 0;
    const noGpsQueue = [];

    // Build session previews + pano detection first
    for (const file of files) {
      const hostedUrl = PHOTOS_BASE + file.name;
      const blobUrl = URL.createObjectURL(file);
      sessionObjectUrls.push(blobUrl);
      previewUrlByHosted.set(hostedUrl, blobUrl);
      const pano = await detectPanorama(blobUrl);
      panoByHosted.set(hostedUrl, pano);
    }

    // Now read GPS and build pins
    for (const file of files) {
      const hostedUrl = PHOTOS_BASE + file.name;
      const title = file.name;
      const is360 = panoByHosted.get(hostedUrl) === true;

      try {
        const gps = await exifr.gps(file);
        if (gps && gps.latitude && gps.longitude) {
          pinData.push({
            id: uid(),
            lat: gps.latitude,
            lng: gps.longitude,
            url: hostedUrl,
            title,
            fileName: file.name,
            is360,
            ts: Date.now()
          });
          addedGps++;
        } else {
          noGpsQueue.push({ url: hostedUrl, title, fileName: file.name, is360 });
        }
      } catch {
        noGpsQueue.push({ url: hostedUrl, title, fileName: file.name, is360 });
      }
    }

    saveLocal();

    // âœ… Do NOT auto-fit/jump the map while youâ€™re about to place no-GPS pins
    renderAllPins(false);

    if (addedGps) statusEl.textContent = `${addedGps} photo(s) pinned from GPS`;
    if (noGpsQueue.length) startManualQueue(noGpsQueue);
    else statusEl.textContent = `${addedGps} photo(s) pinned from GPS`;
  });

  // -------------------------
  // Init
  // -------------------------
  (async () => {
    setMode(null);
    await loadFromPinsJson();
  })();
</script>
</body>
</html>