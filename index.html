<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Market Street 360 Survey Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://unpkg.com/exifr/dist/full.umd.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
    #toolbar { padding:10px; background:#f4f4f4; border-bottom:1px solid #ccc; display:flex; flex-direction:column; gap:8px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #status { margin-left:auto; font-size:13px; color:#444; }
    .hint { font-size:12px; color:#666; }
    button { padding:6px 12px; font-size:14px; cursor:pointer; }
    input[type="text"] { padding:6px 10px; font-size:14px; width:360px; max-width:80vw; }
    label { font-size:13px; color:#333; }
    #map { height: calc(100vh - 122px); }

    .pill { padding:3px 8px; border:1px solid #bbb; border-radius:999px; font-size:12px; background:#fff; display:none; }
    .pill.on { display:inline-flex; border-color:#2c7; background:#eafff2; }

    .popup-wrap { width:290px; }
    .popup-title { font-weight:650; margin-bottom:6px; word-break: break-word; }
    .popup-sub { font-size:12px; color:#555; margin-bottom:8px; word-break: break-word; }
    .popup-img { width:100%; height:auto; border-radius:10px; display:block; cursor:pointer; }
    .popup-actions { margin-top:8px; display:flex; gap:12px; flex-wrap:wrap; }
    .popup-actions a { text-decoration:none; font-size:13px; }
    .popup-actions a:hover { text-decoration:underline; }
    .danger { color:#b00; }
    code { background:#eee; padding:1px 4px; border-radius:4px; }
  </style>
</head>

<body>
  <div id="toolbar">
    <div class="row">
      <strong>Market Street 360 Survey Map</strong>
      <span class="hint">GitHub mode: images must exist in <code>./photos/</code> for hosted preview.</span>
      <div id="status">Loading…</div>
    </div>

    <div class="row">
      <input id="urlInput" type="text" placeholder='Photo URL or filename (e.g. IMG_0570.jpg or photos/IMG_0570.jpg)' />
      <input id="titleInput" type="text" placeholder="Title (optional)" style="width:240px; max-width:45vw;" />
      <label><input id="force360" type="checkbox" /> Force 360</label>
      <button id="addPinBtn" type="button">Add pin (click map)</button>
      <span id="modePill" class="pill"></span>
    </div>

    <div class="row">
      <button id="reloadBtn" type="button">Reload pins.json</button>
      <button id="exportBtn" type="button">Export pins.json</button>
      <button id="importBtn" type="button">Import pins.json</button>
      <input type="file" id="importInput" accept=".json,application/json" style="display:none" />
      <button id="clearBtn" type="button">Clear local pins</button>
      <span class="hint">Publish changes: Export → replace repo <code>pins.json</code> → commit.</span>
    </div>

    <div class="row">
      <label class="hint" style="display:flex; align-items:center; gap:8px;">
        Choose Files:
        <input type="file" id="fileInput" accept=".jpg,.jpeg,image/jpeg" multiple />
        <span class="hint">GPS photos auto-pin. No-GPS photos will ask you to click map to place them (with preview).</span>
      </label>
    </div>
  </div>

  <div id="map"></div>

  <script>
    var PINS_JSON_URL = "./pins.json";
    var PHOTOS_BASE   = "./photos/";
    var LOCAL_KEY     = "market360_pins_shareable_stable_v2";

    var map = L.map("map").setView([37.7749, -122.4194], 13);

    var grayBase = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
      { maxZoom: 20, attribution: "© OpenStreetMap contributors © CARTO" }
    ).addTo(map);

    var aerial = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 20, attribution: "Tiles © Esri" }
    );

    L.control.layers({ "Base (gray)": grayBase, "Aerial": aerial }, {}, { position:"topright" }).addTo(map);

    var statusEl   = document.getElementById("status");
    var urlInput   = document.getElementById("urlInput");
    var titleInput = document.getElementById("titleInput");
    var force360El = document.getElementById("force360");
    var addPinBtn  = document.getElementById("addPinBtn");

    var reloadBtn  = document.getElementById("reloadBtn");
    var exportBtn  = document.getElementById("exportBtn");
    var importBtn  = document.getElementById("importBtn");
    var importInput= document.getElementById("importInput");
    var clearBtn   = document.getElementById("clearBtn");

    var fileInput  = document.getElementById("fileInput");
    var modePill   = document.getElementById("modePill");

    var pinData = [];
    var markerById = new Map();
    var mode = null;
    var manualQueue = [];

    var previewByHosted = new Map();
    var panoByHosted = new Map();
    var sessionBlobUrls = [];

    function esc(s) {
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function uid() {
      return "pin_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
    }

    function normalizeToHostedUrl(input) {
      var raw = String(input || "").trim();
      if (!raw) return null;
      if (/^https?:\/\//i.test(raw)) return raw;
      if (raw.startsWith("./") || raw.startsWith("../") || raw.startsWith("/")) return raw;
      if (raw.startsWith("photos/")) return "./" + raw;
      return PHOTOS_BASE + raw;
    }

    function setMode(nextMode) {
      mode = nextMode;
      if (!mode) {
        modePill.className = "pill";
        modePill.style.display = "none";
        map.getContainer().style.cursor = "";
        return;
      }
      modePill.className = "pill on";
      modePill.style.display = "inline-flex";
      map.getContainer().style.cursor = "crosshair";
      if (mode.type === "place-new") {
        var label = (mode.draft && (mode.draft.title || mode.draft.fileName)) ? (mode.draft.title || mode.draft.fileName) : "photo";
        modePill.textContent = "Click map to place: " + label + " (Esc cancels)";
      } else if (mode.type === "edit") {
        modePill.textContent = "Click map to move pin (Esc cancels)";
      }
    }

    function saveLocal() { localStorage.setItem(LOCAL_KEY, JSON.stringify(pinData)); }

    function loadLocal() {
      try {
        var raw = localStorage.getItem(LOCAL_KEY);
        if (!raw) return false;
        var arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return false;
        pinData = arr.filter(function(p){ return p && typeof p.lat==="number" && typeof p.lng==="number" && p.url; });
        return true;
      } catch { return false; }
    }

    function clearSessionPreviews() {
      sessionBlobUrls.forEach(function(u){ try { URL.revokeObjectURL(u); } catch {} });
      sessionBlobUrls = [];
      previewByHosted.clear();
      panoByHosted.clear();
    }

    function removeAllMarkers() {
      markerById.forEach(function(m){ map.removeLayer(m); });
      markerById.clear();
    }

    function is360(pin) {
      if (pin && pin.is360 === true) return true;
      if (pin && pin.url && panoByHosted.get(pin.url) === true) return true;
      return false;
    }

    function buildPopupHtml(pin) {
      var title = esc(pin.title || pin.fileName || "Photo");
      var hostedUrl = String(pin.url || "");
      var hostedUrlSafe = esc(hostedUrl);

      var localPreview = hostedUrl ? previewByHosted.get(hostedUrl) : null;
      var imgSrc = localPreview || hostedUrl;

      var note = "";
      if (!imgSrc) {
        note = '<div class="popup-sub danger">No preview available.</div>';
      } else if (!localPreview) {
        note = '<div class="popup-sub">Hosted: <code>' + hostedUrlSafe + '</code></div>';
      } else {
        note = '<div class="popup-sub">Local preview (session). Hosted: <code>' + hostedUrlSafe + '</code></div>';
      }

      var pano = is360(pin);
      var imgHtml = imgSrc
        ? '<img class="popup-img" src="' + esc(imgSrc) + '" alt="' + title + '" data-action="' + (pano ? "open360" : "openraw") + '" data-url="' + esc(imgSrc) + '" data-title="' + title + '" />'
        : "";

      var actions = '<div class="popup-actions">';
      if (pano && imgSrc) actions += '<a href="#" data-action="open360" data-url="' + esc(imgSrc) + '" data-title="' + title + '">Open 360 viewer</a>';
      if (imgSrc) actions += '<a href="' + esc(imgSrc) + '" target="_blank" rel="noopener">Open raw</a>';
      actions += '<a href="#" data-action="edit" data-id="' + esc(pin.id) + '">Edit location</a>';
      actions += "</div>";

      var panoHint = pano ? '<div class="popup-sub">360 panorama enabled.</div>' : "";

      return '<div class="popup-wrap">'
        + '<div class="popup-title">' + title + '</div>'
        + note
        + imgHtml
        + panoHint
        + actions
        + '</div>';
    }

    function addOrUpdateMarker(pin) {
      var existing = markerById.get(pin.id);
      var html = buildPopupHtml(pin);
      if (existing) {
        existing.setLatLng([pin.lat, pin.lng]);
        existing.setPopupContent(html);
        return existing;
      }
      var m = L.marker([pin.lat, pin.lng]).addTo(map).bindPopup(html);
      markerById.set(pin.id, m);
      return m;
    }

    function renderAllPins(fit) {
      removeAllMarkers();
      pinData.forEach(function(p){
        if (p && typeof p.lat==="number" && typeof p.lng==="number" && p.url) addOrUpdateMarker(p);
      });
      statusEl.textContent = pinData.length + " pin(s) loaded";
      if (fit && markerById.size) {
        var group = L.featureGroup(Array.from(markerById.values()));
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    // ✅ FIXED: escape closing script tags inside the HTML string using <\/script>
    function open360NewTab(imageUrl, titleText) {
      var w = window.open("", "_blank");
      if (!w) { alert("Popup blocked. Allow popups for this site."); return; }

      var safeTitle = esc(titleText || "360 Photo");
      var safeUrl = esc(imageUrl || "");

      var html = ''
        + '<!doctype html><html><head><meta charset="utf-8" />'
        + '<meta name="viewport" content="width=device-width,initial-scale=1" />'
        + '<title>' + safeTitle + '</title>'
        + '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />'
        + '<style>html,body{margin:0;height:100%;background:#111;font-family:system-ui,-apple-system,BlinkMacSystemFont,Arial;}'
        + '#topbar{position:fixed;left:10px;top:10px;z-index:10;display:flex;gap:10px;align-items:center;flex-wrap:wrap;'
        + 'background:rgba(0,0,0,0.55);color:#fff;padding:8px 10px;border-radius:10px;}'
        + '#topbar a{color:#fff;text-decoration:none;font-size:13px;opacity:0.9;}'
        + '#topbar a:hover{text-decoration:underline;opacity:1;}'
        + '#pano{height:100%;width:100%;}</style></head><body>'
        + '<div id="topbar"><div style="font-weight:650;font-size:13px;">' + safeTitle + '</div>'
        + '<a href="' + safeUrl + '" target="_blank" rel="noopener">Open raw image</a></div>'
        + '<div id="pano"></div>'
        + '<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"><\/script>'
        + '<script>pannellum.viewer("pano",{type:"equirectangular",panorama:' + JSON.stringify(imageUrl) + ',autoLoad:true,showZoomCtrl:true});<\/script>'
        + '</body></html>';

      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    function detectPanorama(blobUrl) {
      return new Promise(function(resolve){
        var img = new Image();
        img.onload = function(){
          var w = img.naturalWidth || img.width;
          var h = img.naturalHeight || img.height;
          if (!w || !h) return resolve(false);
          var r = w / h;
          resolve(r > 1.85 && r < 2.15);
        };
        img.onerror = function(){ resolve(false); };
        img.src = blobUrl;
      });
    }

    function startManualQueue(queue) {
      manualQueue = queue.slice();
      if (!manualQueue.length) { setMode(null); return; }
      var next = manualQueue.shift();
      setMode({ type:"place-new", draft: next });
      statusEl.textContent = 'No GPS: click map to place "' + (next.fileName || next.title || "photo") + '" (' + (manualQueue.length + 1) + " remaining)";
    }

    function continueManualQueue() {
      if (!manualQueue.length) {
        setMode(null);
        statusEl.textContent = "Manual placement complete.";
        return;
      }
      var next = manualQueue.shift();
      setMode({ type:"place-new", draft: next });
      statusEl.textContent = 'No GPS: click map to place "' + (next.fileName || next.title || "photo") + '" (' + (manualQueue.length + 1) + " remaining)";
    }

    document.addEventListener("click", function(evt){
      var el = evt.target.closest ? evt.target.closest("[data-action]") : null;
      if (!el) return;

      var action = el.getAttribute("data-action");

      if (action === "open360") {
        evt.preventDefault(); evt.stopPropagation();
        var url = el.getAttribute("data-url");
        var title = el.getAttribute("data-title") || "360 Photo";
        if (url) open360NewTab(url, title);
        return;
      }

      if (action === "openraw") {
        evt.preventDefault(); evt.stopPropagation();
        var u = el.getAttribute("data-url");
        if (u) window.open(u, "_blank", "noopener");
        return;
      }

      if (action === "edit") {
        evt.preventDefault(); evt.stopPropagation();
        var id = el.getAttribute("data-id");
        if (!id) return;
        manualQueue = [];
        setMode({ type:"edit", pinId: id });
        statusEl.textContent = "Click map to set new location…";
        return;
      }
    });

    map.on("click", function(evt){
      if (!mode) return;

      var lat = evt.latlng.lat;
      var lng = evt.latlng.lng;

      if (mode.type === "place-new") {
        var d = mode.draft;
        if (!d || !d.url) { setMode(null); return; }

        var pin = {
          id: uid(),
          lat: lat,
          lng: lng,
          url: d.url,
          title: d.title || "",
          fileName: d.fileName || "",
          is360: d.is360 === true,
          ts: Date.now()
        };

        pinData.push(pin);
        saveLocal();
        renderAllPins(false);

        var m = markerById.get(pin.id);
        if (m) m.openPopup();

        setMode(null);
        map.setView([lat, lng], Math.max(map.getZoom(), 18));

        if (manualQueue.length) continueManualQueue();
        return;
      }

      if (mode.type === "edit") {
        var idx = pinData.findIndex(function(p){ return p.id === mode.pinId; });
        if (idx < 0) { setMode(null); return; }
        pinData[idx].lat = lat;
        pinData[idx].lng = lng;
        saveLocal();
        renderAllPins(false);

        var mm = markerById.get(pinData[idx].id);
        if (mm) mm.openPopup();

        setMode(null);
        map.setView([lat, lng], Math.max(map.getZoom(), 18));
      }
    });

    window.addEventListener("keydown", function(e){
      if (e.key === "Escape") {
        manualQueue = [];
        setMode(null);
        statusEl.textContent = "Cancelled.";
      }
    });

    async function loadFromPinsJson() {
      try {
        var res = await fetch(PINS_JSON_URL, { cache:"no-store" });
        if (!res.ok) throw new Error("pins.json not found");
        var arr = await res.json();
        if (!Array.isArray(arr)) throw new Error("pins.json invalid");
        pinData = arr
          .filter(function(p){ return p && typeof p.lat==="number" && typeof p.lng==="number" && p.url; })
          .map(function(p){
            return {
              id: String(p.id || uid()),
              lat: p.lat,
              lng: p.lng,
              url: String(p.url),
              title: p.title ? String(p.title) : "",
              fileName: p.fileName ? String(p.fileName) : "",
              is360: p.is360 === true,
              ts: p.ts || Date.now()
            };
          });
        saveLocal();
        renderAllPins(true);
      } catch (e) {
        var ok = loadLocal();
        renderAllPins(true);
        statusEl.textContent = ok ? (pinData.length + " pin(s) loaded (local)") : "No pins loaded yet";
      }
    }

    addPinBtn.addEventListener("click", function(){
      var hostedUrl = normalizeToHostedUrl(urlInput.value);
      if (!hostedUrl) { alert("Enter a photo URL or filename first."); return; }

      var draft = {
        url: hostedUrl,
        title: String(titleInput.value || "").trim(),
        fileName: hostedUrl.split("/").pop(),
        is360: force360El.checked === true
      };

      manualQueue = [];
      setMode({ type:"place-new", draft: draft });
      statusEl.textContent = "Click map to place pin…";
    });

    exportBtn.addEventListener("click", function(){
      var blob = new Blob([JSON.stringify(pinData, null, 2)], { type:"application/json" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "pins.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener("click", function(){ importInput.click(); });

    importInput.addEventListener("change", async function(e){
      var f = e.target.files[0];
      if (!f) return;
      try {
        var txt = await f.text();
        var arr = JSON.parse(txt);
        if (!Array.isArray(arr)) throw new Error("bad");
        pinData = arr
          .filter(function(p){ return p && typeof p.lat==="number" && typeof p.lng==="number" && p.url; })
          .map(function(p){
            return {
              id: String(p.id || uid()),
              lat: p.lat,
              lng: p.lng,
              url: String(p.url),
              title: p.title ? String(p.title) : "",
              fileName: p.fileName ? String(p.fileName) : "",
              is360: p.is360 === true,
              ts: p.ts || Date.now()
            };
          });
        saveLocal();
        renderAllPins(true);
        statusEl.textContent = "Imported " + pinData.length + " pin(s)";
      } catch {
        alert("Could not import JSON.");
      } finally {
        importInput.value = "";
      }
    });

    clearBtn.addEventListener("click", function(){
      if (!confirm("Clear local pins + local previews?")) return;
      clearSessionPreviews();
      pinData = [];
      saveLocal();
      removeAllMarkers();
      setMode(null);
      statusEl.textContent = "No pins loaded yet";
      fileInput.value = "";
    });

    reloadBtn.addEventListener("click", async function(){ await loadFromPinsJson(); });

    fileInput.addEventListener("change", async function(event){
      var files = Array.from(event.target.files || []);
      if (!files.length) return;

      clearSessionPreviews();

      var addedGps = 0;
      var noGpsQueue = [];

      for (var i=0; i<files.length; i++) {
        var file = files[i];
        var hostedUrl = PHOTOS_BASE + file.name;
        var blobUrl = URL.createObjectURL(file);
        sessionBlobUrls.push(blobUrl);
        previewByHosted.set(hostedUrl, blobUrl);

        var pano = await detectPanorama(blobUrl);
        panoByHosted.set(hostedUrl, pano);
      }

      for (var j=0; j<files.length; j++) {
        var f2 = files[j];
        var hosted2 = PHOTOS_BASE + f2.name;
        var panoFlag = panoByHosted.get(hosted2) === true;

        try {
          var gps = await exifr.gps(f2);
          if (gps && gps.latitude && gps.longitude) {
            pinData.push({
              id: uid(),
              lat: gps.latitude,
              lng: gps.longitude,
              url: hosted2,
              title: "",
              fileName: f2.name,
              is360: panoFlag,
              ts: Date.now()
            });
            addedGps++;
          } else {
            noGpsQueue.push({ url: hosted2, title: "", fileName: f2.name, is360: panoFlag });
          }
        } catch {
          noGpsQueue.push({ url: hosted2, title: "", fileName: f2.name, is360: panoFlag });
        }
      }

      saveLocal();
      renderAllPins(true);

      if (addedGps) statusEl.textContent = addedGps + " photo(s) pinned from GPS";
      if (noGpsQueue.length) startManualQueue(noGpsQueue);

      fileInput.value = "";
    });

    setMode(null);
    loadFromPinsJson();
  </script>
</body>
</html>
