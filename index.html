<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Market Street 360 Survey Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Read GPS from local JPGs (authoring only) -->
  <script src="https://unpkg.com/exifr/dist/full.umd.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont; }
    #toolbar {
      display: flex; align-items: center; gap: 10px;
      padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ccc;
      flex-wrap: wrap;
    }
    #map { height: calc(100vh - 92px); }

    button { padding: 6px 12px; font-size: 14px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: default; }
    input[type="text"] { padding: 6px 10px; font-size: 14px; width: 340px; max-width: 70vw; }
    label { font-size: 13px; color: #333; }
    .hint { font-size: 12px; color: #666; }
    #status { margin-left: auto; font-size: 13px; color: #444; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; width:100%; }
    .pill {
      padding: 3px 8px; border: 1px solid #bbb; border-radius: 999px;
      font-size: 12px; background: #fff;
    }

    .popup-wrap { width: 280px; }
    .popup-title { font-weight: 650; margin-bottom: 6px; word-break: break-word; }
    .popup-sub { font-size: 12px; color:#555; margin-bottom: 8px; word-break: break-word; }
    .popup-img { width: 100%; height: auto; border-radius: 8px; display: block; cursor: pointer; }
    .popup-actions { margin-top: 8px; display: flex; gap: 12px; flex-wrap: wrap; }
    .popup-actions a { text-decoration: none; font-size: 13px; }
    .popup-actions a:hover { text-decoration: underline; }
  </style>
</head>

<body>
  <div id="toolbar">
    <div class="row">
      <strong>Market Street 360 Survey Map</strong>
      <span class="hint">Shareable mode (GitHub): pins point to hosted image URLs.</span>
      <div id="status">Loading…</div>
    </div>

    <div class="row">
      <input id="urlInput" type="text" placeholder='Photo URL or filename (e.g. photos/R0010254.JPG or just R0010254.JPG)' />
      <input id="titleInput" type="text" placeholder='Title (optional)' style="width:240px; max-width:45vw;" />
      <label><input id="force360" type="checkbox" /> Force 360</label>
      <button id="addPinBtn" type="button">Add pin (click map)</button>
      <span id="modePill" class="pill" style="display:none;"></span>
    </div>

    <div class="row">
      <button id="reloadBtn" type="button">Reload pins.json</button>
      <button id="exportBtn" type="button">Export pins.json</button>
      <button id="importBtn" type="button">Import pins.json</button>
      <input type="file" id="importInput" accept=".json,application/json" style="display:none" />
      <button id="clearBtn" type="button">Clear local pins</button>
      <span class="hint">To publish changes: Export → replace pins.json in your repo → commit.</span>
    </div>

    <div class="row">
      <label class="hint" style="display:flex; align-items:center; gap:8px;">
        Choose Files: <input type="file" id="fileInput" accept=".jpg,.jpeg,image/jpeg" multiple />
        <span class="hint">GPS photos auto-pin. No-GPS photos will ask you to click the map to place them.</span>
      </label>
    </div>
  </div>

  <div id="map"></div>

  <script>
    // =========================
    // Config (GitHub Pages)
    // =========================
    const PINS_JSON_URL = "./pins.json";
    const PHOTOS_BASE   = "./photos/";

    // Draft edits stored locally (then you Export → commit to pins.json)
    const LOCAL_STORAGE_KEY = "market360_pins_shareable_v2";

    // =========================
    // Map + baselayers
    // =========================
    const map = L.map("map").setView([37.7749, -122.4194], 13);

    // Keep your preferred gray look
    const grayBase = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
      { maxZoom: 20, attribution: "© OpenStreetMap contributors © CARTO" }
    ).addTo(map);

    const aerialBase = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 20, attribution: "Tiles © Esri" }
    );

    L.control.layers(
      { "Light (default)": grayBase, "Aerial": aerialBase },
      null,
      { position: "topright", collapsed: true }
    ).addTo(map);

    // =========================
    // UI elements
    // =========================
    const statusEl    = document.getElementById("status");
    const modePill    = document.getElementById("modePill");
    const urlInput    = document.getElementById("urlInput");
    const titleInput  = document.getElementById("titleInput");
    const force360El  = document.getElementById("force360");
    const addPinBtn   = document.getElementById("addPinBtn");
    const reloadBtn   = document.getElementById("reloadBtn");
    const exportBtn   = document.getElementById("exportBtn");
    const importBtn   = document.getElementById("importBtn");
    const importInput = document.getElementById("importInput");
    const clearBtn    = document.getElementById("clearBtn");
    const fileInput   = document.getElementById("fileInput");

    // =========================
    // State
    // =========================
    let pinData = [];
    const markerById = new Map();
    let mode = null; // {type:"place-new", pinDraft} or {type:"edit", pinId}
    let manualQueue = []; // pins waiting for click placement

    // Prevent multi-tab opens
    let lastOpenTs = 0;
    function canOpenNow() {
      const now = Date.now();
      if (now - lastOpenTs < 650) return false;
      lastOpenTs = now;
      return true;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function ensureId() {
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return String(Date.now()) + "_" + Math.random();
    }

    function setMode(nextMode) {
      mode = nextMode;

      if (!mode) {
        modePill.style.display = "none";
        map.getContainer().style.cursor = "";
        return;
      }

      modePill.style.display = "inline-block";
      map.getContainer().style.cursor = "crosshair";

      if (mode.type === "place-new") {
        const t = mode.pinDraft?.title || mode.pinDraft?.name || "photo";
        modePill.textContent = `Click map to place: ${t}  (Esc cancels)`;
      } else if (mode.type === "edit") {
        modePill.textContent = "Click new location (Esc cancels)";
      }
    }

    function saveLocalDraftPins() {
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pinData));
    }

    function loadLocalDraftPins() {
      try {
        const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        if (Array.isArray(parsed)) return parsed;
      } catch {}
      return null;
    }

    function removeAllMarkers() {
      markerById.forEach(m => map.removeLayer(m));
      markerById.clear();
    }

    function normalizeUrlOrFilename(input) {
      const v = (input || "").trim();
      if (!v) return null;

      // If user types just "R0010254.JPG", use PHOTOS_BASE
      if (!v.includes("/") && !v.startsWith("http://") && !v.startsWith("https://")) {
        return PHOTOS_BASE + encodeURIComponent(v);
      }

      return v;
    }

    async function detectPanoramaFromUrl(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const w = img.naturalWidth || img.width;
          const h = img.naturalHeight || img.height;
          if (!w || !h) return resolve(false);
          const ratio = w / h;
          resolve(ratio > 1.85 && ratio < 2.15);
        };
        img.onerror = () => resolve(false);
        img.src = url;
      });
    }

    function openPannellumViewer(url, title) {
      if (!canOpenNow()) return;

      const safeTitle = escapeHtml(title || "360 Photo");
      const viewerUrl = url;

      const w = window.open("", "_blank");
      if (!w) {
        alert("Popup blocked. Please allow popups for this site.");
        return;
      }

      const html =
        '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" />' +
        '<meta name="viewport" content="width=device-width, initial-scale=1" />' +
        '<title>' + safeTitle + '</title>' +
        '<link rel="stylesheet" href="https://unpkg.com/pannellum/build/pannellum.css"/>' +
        '<style>html,body{height:100%;margin:0;background:#000;}#pano{width:100%;height:100%;}' +
        '#topbar{position:fixed;top:10px;left:10px;z-index:9999;display:flex;gap:10px;align-items:center;' +
        'padding:8px 10px;border-radius:10px;background:rgba(0,0,0,0.55);color:#fff;font-family:system-ui;' +
        'font-size:13px;}#topbar a{color:#fff;text-decoration:underline;}</style>' +
        '</head><body>' +
        '<div id="topbar"><div>' + safeTitle + '</div><a href="' + viewerUrl + '" target="_blank">Open raw image</a></div>' +
        '<div id="pano"></div>' +
        '<script src="https://unpkg.com/pannellum/build/pannellum.js"><\/script>' +
        '<script>pannellum.viewer("pano",{type:"equirectangular",panorama:' + JSON.stringify(viewerUrl) +
        ',autoLoad:true,showZoomCtrl:true,showFullscreenCtrl:true});<\/script>' +
        '</body></html>';

      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    function findPinByUrl(url) {
      return pinData.find(p => p && p.url === url) || null;
    }

    function buildPopupHtml(pin) {
      const safeTitle = escapeHtml(pin.title || pin.name || "Photo");
      const safeUrl   = escapeHtml(pin.url || "");
      const isPano    = !!pin.isPano;

      const openPrimary = isPano
        ? '<a href="#" data-action="open360" data-id="' + pin.id + '">Open 360 viewer (new tab)</a>'
        : '<a href="' + safeUrl + '" target="_blank" rel="noopener">Open full screen (new tab)</a>';

      const panoHint = isPano
        ? '<div class="hint">Detected/marked as 360 panorama (equirectangular).</div>'
        : '';

      return ''
        + '<div class="popup-wrap">'
        +   '<div class="popup-title">' + safeTitle + '</div>'
        +   '<div class="popup-sub">' + safeUrl + '</div>'
        +   '<img class="popup-img" src="' + safeUrl + '" alt="' + safeTitle + '" data-action="' + (isPano ? 'open360' : 'openraw') + '" />'
        +   '<div class="popup-actions">'
        +     openPrimary
        +     '<a href="#" data-action="editLoc" data-id="' + pin.id + '">Edit location</a>'
        +     '<a href="#" data-action="editMeta" data-id="' + pin.id + '">Edit title/url</a>'
        +   '</div>'
        +   panoHint
        + '</div>';
    }

    function addOrUpdateMarker(pin) {
      const existing = markerById.get(pin.id);
      const html = buildPopupHtml(pin);

      if (existing) {
        existing.setLatLng([pin.lat, pin.lng]);
        existing.setPopupContent(html);
        return existing;
      }

      const m = L.marker([pin.lat, pin.lng]).addTo(map).bindPopup(html);
      markerById.set(pin.id, m);
      return m;
    }

    function renderAllPins({ fit = false } = {}) {
      removeAllMarkers();

      for (const pin of pinData) {
        if (!pin || typeof pin.lat !== "number" || typeof pin.lng !== "number" || !pin.url) continue;
        addOrUpdateMarker(pin);
      }

      const count = markerById.size;
      statusEl.textContent = count ? `${count} pin(s) loaded` : "No pins loaded";

      if (fit && count) {
        const group = L.featureGroup([...markerById.values()]);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    async function loadPinsFromPinsJson() {
      statusEl.textContent = "Loading pins.json…";
      try {
        const resp = await fetch(PINS_JSON_URL, { cache: "no-store" });
        if (!resp.ok) throw new Error("Could not fetch pins.json");
        const data = await resp.json();
        if (!Array.isArray(data)) throw new Error("pins.json must be an array");
        return data;
      } catch (e) {
        console.warn(e);
        return null;
      }
    }

    function cleanPins(arr) {
      return (arr || [])
        .filter(p => p && typeof p.lat === "number" && typeof p.lng === "number" && typeof p.url === "string")
        .map(p => ({
          id: p.id || ensureId(),
          name: String(p.name || p.title || "Photo"),
          title: p.title ? String(p.title) : "",
          url: String(p.url),
          lat: p.lat,
          lng: p.lng,
          isPano: !!p.isPano,
          ts: p.ts || Date.now()
        }));
    }

    async function bootLoadPins() {
      const localDraft = loadLocalDraftPins();
      if (localDraft && localDraft.length) {
        pinData = cleanPins(localDraft);
        renderAllPins({ fit: true });
        return;
      }

      const fromJson = await loadPinsFromPinsJson();
      if (fromJson) {
        pinData = cleanPins(fromJson);
        saveLocalDraftPins();
        renderAllPins({ fit: true });
        return;
      }

      pinData = [];
      renderAllPins();
      statusEl.textContent = "No pins loaded (no local draft, and pins.json missing/unreachable)";
    }

    function startManualQueue(queueItems) {
      manualQueue = queueItems.slice();

      if (!manualQueue.length) {
        setMode(null);
        return;
      }

      const next = manualQueue.shift();
      setMode({ type: "place-new", pinDraft: next });
      statusEl.textContent = `No GPS: click map to place "${next.name}" (${manualQueue.length + 1} remaining)`;
    }

    function continueManualQueueIfAny() {
      if (!manualQueue.length) {
        setMode(null);
        statusEl.textContent = "Manual placement complete.";
        return;
      }
      const next = manualQueue.shift();
      setMode({ type: "place-new", pinDraft: next });
      statusEl.textContent = `No GPS: click map to place "${next.name}" (${manualQueue.length + 1} remaining)`;
    }

    // =========================
    // Events
    // =========================
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        manualQueue = [];
        setMode(null);
        statusEl.textContent = "Cancelled.";
      }
    });

    reloadBtn.addEventListener("click", async () => {
      const fromJson = await loadPinsFromPinsJson();
      if (!fromJson) {
        alert("Could not load pins.json. Make sure it exists in your repo root.");
        return;
      }
      pinData = cleanPins(fromJson);
      saveLocalDraftPins();
      renderAllPins({ fit: true });
    });

    exportBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(pinData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "pins.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener("click", () => importInput.click());

    importInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const imported = JSON.parse(text);
        if (!Array.isArray(imported)) {
          alert("Invalid JSON format. Expected an array.");
          return;
        }
        pinData = cleanPins(imported);
        saveLocalDraftPins();
        renderAllPins({ fit: true });
        statusEl.textContent = `Imported ${pinData.length} pin(s)`;
      } catch (err) {
        console.error(err);
        alert("Could not import JSON.");
      } finally {
        importInput.value = "";
      }
    });

    clearBtn.addEventListener("click", () => {
      if (!confirm("Clear local draft pins (does not delete pins.json on GitHub)?")) return;
      pinData = [];
      saveLocalDraftPins();
      renderAllPins();
    });

    addPinBtn.addEventListener("click", async () => {
      const url = normalizeUrlOrFilename(urlInput.value);
      if (!url) {
        alert("Type a photo URL or filename first.");
        return;
      }

      const title = (titleInput.value || "").trim();
      let isPano = force360El.checked;

      if (!isPano) {
        statusEl.textContent = "Detecting 360…";
        isPano = await detectPanoramaFromUrl(url);
      }

      setMode({ type: "place-new", pinDraft: {
        id: ensureId(),
        name: title || (url.split("/").pop() || "Photo"),
        title,
        url,
        isPano
      }});
      statusEl.textContent = "Click map to place the pin…";
    });

    map.on("popupopen", (e) => {
      const el = e.popup.getElement();
      if (!el) return;
      if (el.dataset.boundClick === "1") return;
      el.dataset.boundClick = "1";

      el.addEventListener("click", (evt) => {
        const img = evt.target?.classList?.contains("popup-img") ? evt.target : null;
        const a = evt.target.closest ? evt.target.closest("a") : null;

        if (img) {
          evt.preventDefault();
          evt.stopPropagation();

          const idEl = el.querySelector('a[data-action="editLoc"]');
          const pinId = idEl ? idEl.getAttribute("data-id") : null;
          const pin = pinData.find(p => p.id === pinId);
          if (!pin) return;

          const action = img.getAttribute("data-action");
          if (action === "open360") {
            openPannellumViewer(pin.url, pin.title || pin.name);
          } else {
            if (!canOpenNow()) return;
            window.open(pin.url, "_blank");
          }
          return;
        }

        if (!a) return;
        const actionA = a.getAttribute("data-action");
        const id = a.getAttribute("data-id");
        const pin = pinData.find(p => p.id === id);
        if (!pin) return;

        if (actionA === "open360") {
          evt.preventDefault();
          evt.stopPropagation();
          openPannellumViewer(pin.url, pin.title || pin.name);
          return;
        }

        if (actionA === "editLoc") {
          evt.preventDefault();
          evt.stopPropagation();
          manualQueue = [];
          setMode({ type: "edit", pinId: id });
          e.popup.close();
          return;
        }

        if (actionA === "editMeta") {
          evt.preventDefault();
          evt.stopPropagation();
          const newTitle = prompt("Title (optional):", pin.title || "");
          if (newTitle === null) return;

          const newUrl = prompt("Image URL (or filename):", pin.url || "");
          if (newUrl === null) return;

          const normalized = normalizeUrlOrFilename(newUrl);
          if (!normalized) return;

          pin.title = (newTitle || "").trim();
          pin.url = normalized;

          saveLocalDraftPins();
          renderAllPins();
          const marker = markerById.get(pin.id);
          if (marker) marker.openPopup();
          return;
        }
      });
    });

    map.on("click", async (evt) => {
      if (!mode) return;

      const { lat, lng } = evt.latlng;

      if (mode.type === "place-new") {
        const d = mode.pinDraft;
        if (!d || !d.url) { setMode(null); return; }

        // If a pin with same URL already exists, treat this as "set location" (avoid duplicates)
        const existing = findPinByUrl(d.url);
        if (existing) {
          existing.lat = lat;
          existing.lng = lng;
          existing.title = d.title || existing.title;
          existing.isPano = (typeof d.isPano === "boolean") ? d.isPano : existing.isPano;
          existing.ts = Date.now();
          saveLocalDraftPins();
          renderAllPins();
          setMode(null);
          const marker = markerById.get(existing.id);
          if (marker) marker.openPopup();
          statusEl.textContent = `Placed existing photo: "${existing.name}"`;
          continueManualQueueIfAny();
          return;
        }

        const pin = {
          id: d.id || ensureId(),
          name: d.name || (d.url.split("/").pop() || "Photo"),
          title: (d.title || "").trim(),
          url: d.url,
          lat, lng,
          isPano: !!d.isPano,
          ts: Date.now()
        };

        pinData.push(pin);
        saveLocalDraftPins();
        renderAllPins();
        setMode(null);

        const marker = markerById.get(pin.id);
        if (marker) marker.openPopup();

        statusEl.textContent = `Pinned "${pin.name}"`;
        map.setView([lat, lng], Math.max(map.getZoom(), 18));

        // If this came from the no-GPS queue, proceed to next
        continueManualQueueIfAny();
        return;
      }

      if (mode.type === "edit") {
        const idx = pinData.findIndex(p => p.id === mode.pinId);
        if (idx < 0) { setMode(null); return; }

        pinData[idx].lat = lat;
        pinData[idx].lng = lng;

        saveLocalDraftPins();
        renderAllPins();
        setMode(null);

        const marker = markerById.get(pinData[idx].id);
        if (marker) marker.openPopup();

        statusEl.textContent = "Location updated.";
        map.setView([lat, lng], Math.max(map.getZoom(), 18));
      }
    });

    // =========================
    // Choose Files: GPS auto-pin + No-GPS -> click-to-place queue
    // =========================
    fileInput.addEventListener("change", async (event) => {
      const files = Array.from(event.target.files || []);
      if (!files.length) return;

      let addedGps = 0;
      let queuedManual = 0;

      const queue = [];

      for (const file of files) {
        const name = file.name;
        const hostedUrl = PHOTOS_BASE + encodeURIComponent(name);

        // Detect pano (best-effort) using hosted URL
        let isPano = false;
        try { isPano = await detectPanoramaFromUrl(hostedUrl); } catch {}

        try {
          const gps = await exifr.gps(file);
          if (gps && gps.latitude && gps.longitude) {
            // If already exists (same hosted url), update coords instead of duplicating
            const existing = findPinByUrl(hostedUrl);
            if (existing) {
              existing.lat = gps.latitude;
              existing.lng = gps.longitude;
              existing.isPano = isPano;
              existing.ts = Date.now();
            } else {
              pinData.push({
                id: ensureId(),
                name,
                title: "",
                url: hostedUrl,
                lat: gps.latitude,
                lng: gps.longitude,
                isPano,
                ts: Date.now()
              });
            }
            addedGps++;
          } else {
            queue.push({
              id: ensureId(),
              name,
              title: "",
              url: hostedUrl,
              isPano
            });
            queuedManual++;
          }
        } catch {
          queue.push({
            id: ensureId(),
            name,
            title: "",
            url: hostedUrl,
            isPano
          });
          queuedManual++;
        }
      }

      saveLocalDraftPins();
      renderAllPins({ fit: true });

      if (addedGps && !queuedManual) {
        statusEl.textContent = `Added/updated ${addedGps} GPS pin(s).`;
      } else if (addedGps && queuedManual) {
        statusEl.textContent = `Added/updated ${addedGps} GPS pin(s). ${queuedManual} need manual placement.`;
      } else if (!addedGps && queuedManual) {
        statusEl.textContent = `${queuedManual} photo(s) have no GPS. Click map to place them.`;
      }

      // Start manual placement queue automatically
      if (queue.length) {
        startManualQueue(queue);
      }

      fileInput.value = "";
    });

    // Boot
    bootLoadPins();
  </script>
</body>
</html>
