<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Street 360 Survey Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- EXIF GPS reader -->
  <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #topbar {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      background: #fff;
    }
    #titleRow { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    #titleRow h1 { font-size: 18px; margin: 0; font-weight: 650; }
    #titleRow .hint { color:#555; font-size: 12px; }

    #controls {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    button, input[type="text"] {
      font-size: 13px;
      padding: 7px 10px;
      border: 1px solid #bbb;
      border-radius: 6px;
      background:#fff;
    }
    button { cursor:pointer; }
    button:hover { background:#f5f5f5; }
    .pill {
      font-size: 12px;
      color:#333;
      background:#f2f2f2;
      border: 1px solid #ddd;
      padding: 6px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .spacer { flex: 1 1 auto; }
    #status { font-size: 12px; color:#333; }
    #map { height: calc(100% - 120px); }
    @media (max-width: 900px) {
      #map { height: calc(100% - 170px); }
    }

    /* Popup */
    .popup-title { font-weight: 700; margin: 0 0 6px 0; }
    .popup-note { font-size: 12px; color:#555; margin: 0 0 8px 0; }
    .popup-img {
      width: 260px;
      max-width: 70vw;
      border-radius: 8px;
      display:block;
      border: 1px solid #ddd;
      margin: 6px 0 8px 0;
    }
    .popup-actions a {
      display:inline-block;
      margin-right: 10px;
      font-size: 13px;
      text-decoration: none;
      color:#0b66c3;
    }
    .popup-actions a:hover { text-decoration: underline; }

    /* Viewer tab (simple pano viewer using CSS background + mouse drag) */
    .viewerWrap { position: fixed; inset: 0; background:#111; color:#fff; display:flex; flex-direction:column; }
    .viewerTop {
      display:flex; gap:10px; align-items:center;
      padding:10px 12px; background:#0d0d0d; border-bottom:1px solid #333;
      font-size: 13px;
    }
    .viewerTop .name { font-weight:700; }
    .viewerTop a { color:#9ad; text-decoration:none; }
    .viewerTop a:hover { text-decoration:underline; }
    .viewer {
      flex: 1 1 auto;
      position: relative;
      overflow: hidden;
      cursor: grab;
      background:#111;
    }
    .viewer:active { cursor: grabbing; }
    .panoLayer {
      position:absolute; inset:0;
      background-repeat: repeat-x;
      background-position: 0px 50%;
      background-size: auto 100%;
      filter: none;
    }
    .viewerHelp {
      position:absolute; left:12px; bottom:12px;
      background: rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.15);
      padding:8px 10px; border-radius:10px;
      font-size: 12px; color:#eee;
    }
  </style>
</head>

<body>
  <div id="topbar">
    <div id="titleRow">
      <h1>Market Street 360 Survey Map</h1>
      <div class="hint">GitHub mode: images should exist in <b>./photos/</b>. Local “Choose Files” is for authoring.</div>
    </div>

    <div id="controls">
      <span class="pill"><b>Publish workflow:</b> upload photos → Export pins.json → replace repo pins.json → commit</span>
      <span class="spacer"></span>
      <span id="status">Loading…</span>
    </div>

    <div id="controls">
      <button id="reloadPinsBtn">Reload pins.json</button>
      <button id="exportPinsBtn">Export pins.json</button>
      <button id="importPinsBtn">Import pins.json</button>
      <button id="clearLocalBtn">Clear local pins</button>

      <span class="spacer"></span>

      <label class="pill" style="display:flex;align-items:center;gap:8px;">
        Author mode (optional):
        <input id="fileInput" type="file" accept=".jpg,.jpeg,.png,.heic,.heif" multiple />
      </label>
    </div>
  </div>

  <div id="map"></div>

  <!-- Hidden file input for importing pins.json -->
  <input id="importInput" type="file" accept=".json" style="display:none" />

<script>
(function(){
  // -------------------------
  // Viewer-tab mode (opens at index.html#viewer)
  // -------------------------
  if (location.hash.startsWith("#viewer")) {
    document.body.innerHTML = `
      <div class="viewerWrap">
        <div class="viewerTop">
          <span class="name" id="vn">360 Viewer</span>
          <a href="#" id="openRaw">Open raw image</a>
          <span style="opacity:.6">| Drag to pan</span>
        </div>
        <div class="viewer" id="viewer">
          <div class="panoLayer" id="pano"></div>
          <div class="viewerHelp">If this is blank: the photo URL is missing in /photos/ or the opener blocked sending the image.</div>
        </div>
      </div>
    `;

    const panoEl = document.getElementById("pano");
    const nameEl = document.getElementById("vn");
    const openRaw = document.getElementById("openRaw");

    // allow setting pano via query ?url=...
    const params = new URLSearchParams(location.search);
    let currentUrl = params.get("url") || "";

    function setPano(url, title){
      currentUrl = url || currentUrl;
      if (title) nameEl.textContent = title;
      if (!currentUrl) return;
      panoEl.style.backgroundImage = `url("${currentUrl}")`;
      openRaw.href = currentUrl;
      openRaw.target = "_blank";
      openRaw.rel = "noopener";
    }

    // Receive local blob from opener (postMessage)
    window.addEventListener("message", (ev) => {
      if (!ev || !ev.data) return;
      if (ev.data.type === "PANO_URL") {
        setPano(ev.data.url, ev.data.title || "360 Viewer");
      }
    });

    // Drag to pan
    const viewer = document.getElementById("viewer");
    let down = false, lastX = 0, offsetX = 0;
    viewer.addEventListener("mousedown", (e) => { down=true; lastX=e.clientX; });
    window.addEventListener("mouseup", () => down=false);
    window.addEventListener("mousemove", (e) => {
      if (!down) return;
      const dx = e.clientX - lastX;
      lastX = e.clientX;
      offsetX += dx;
      panoEl.style.backgroundPosition = `${offsetX}px 50%`;
    });

    // Touch
    viewer.addEventListener("touchstart", (e) => {
      down=true; lastX = e.touches[0].clientX;
    }, {passive:true});
    viewer.addEventListener("touchend", () => down=false);
    viewer.addEventListener("touchmove", (e) => {
      if (!down) return;
      const x = e.touches[0].clientX;
      const dx = x - lastX;
      lastX = x;
      offsetX += dx;
      panoEl.style.backgroundPosition = `${offsetX}px 50%`;
    }, {passive:true});

    // If opened directly with ?url=
    if (currentUrl) setPano(currentUrl, params.get("title") || "360 Viewer");

    // Done: do not run map code
    return;
  }

  // -------------------------
  // Constants
  // -------------------------
  const PHOTOS_BASE = "photos/";      // repo folder
  const PINS_JSON_URL = "pins.json";  // repo root
  const LOCAL_KEY = "market360_local_pins_v1";

  // -------------------------
  // UI refs
  // -------------------------
  const statusEl = document.getElementById("status");
  const reloadPinsBtn = document.getElementById("reloadPinsBtn");
  const exportPinsBtn = document.getElementById("exportPinsBtn");
  const importPinsBtn = document.getElementById("importPinsBtn");
  const clearLocalBtn = document.getElementById("clearLocalBtn");
  const fileInput = document.getElementById("fileInput");
  const importInput = document.getElementById("importInput");

  // -------------------------
  // State
  // -------------------------
  let pinData = [];
  let markerById = new Map();

  // Local previews (only valid during this browser session)
  let sessionObjectUrls = [];
  const previewUrlByHosted = new Map(); // hostedUrl -> blobUrl (session)
  const isPanoByHosted = new Map();     // hostedUrl -> boolean

  // Placement mode
  let mode = null; // {type:"place-new", draft:{...}} or {type:"edit", pinId:"..."}
  let manualQueue = []; // drafts that need manual placement

  // -------------------------
  // Map setup (GRAY base + optional satellite overlay)
  // -------------------------
  const map = L.map("map", { zoomControl: true }).setView([37.7892, -122.4015], 16);

  // Gray base (CARTO Positron-like light)
  const gray = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
    { maxZoom: 20, attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }
  ).addTo(map);

  // Satellite overlay toggle (Esri)
  const sat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 20, attribution: "Tiles &copy; Esri" }
  );

  L.control.layers(
    { "Gray (default)": gray },
    { "Satellite overlay": sat },
    { position: "topright", collapsed: true }
  ).addTo(map);

  // -------------------------
  // Helpers
  // -------------------------
  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function uid() {
    return "p_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
  }

  function saveLocal() {
    try { localStorage.setItem(LOCAL_KEY, JSON.stringify(pinData)); } catch {}
  }

  function loadLocal() {
    try {
      const raw = localStorage.getItem(LOCAL_KEY);
      if (!raw) return false;
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return false;
      pinData = arr;
      return true;
    } catch {
      return false;
    }
  }

  function clearSessionPreviews() {
    for (const u of sessionObjectUrls) {
      try { URL.revokeObjectURL(u); } catch {}
    }
    sessionObjectUrls = [];
    previewUrlByHosted.clear();
    isPanoByHosted.clear();
  }

  function normalizeToHostedUrl(filenameOrUrl) {
    const v = String(filenameOrUrl || "").trim();
    if (!v) return "";
    if (/^https?:\/\//i.test(v)) return v;
    if (v.startsWith(PHOTOS_BASE)) return v;
    return PHOTOS_BASE + v;
  }

  function is360ForPin(pin) {
    return pin && pin.is360 === true;
  }

  // Detect 360 pano by aspect ratio ~2:1 (equirectangular)
  function detectPanorama(blobUrl) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const w = img.naturalWidth || img.width;
        const h = img.naturalHeight || img.height;
        if (!w || !h) return resolve(false);
        const r = w / h;
        resolve(r > 1.85 && r < 2.15);
      };
      img.onerror = () => resolve(false);
      img.src = blobUrl;
    });
  }

  // -------------------------
  // Popup HTML
  // -------------------------
  function buildPopupHtml(pin) {
    const title = escapeHtml(pin.title || pin.fileName || "Photo");
    const url = pin.url ? String(pin.url) : "";
    const safeUrl = escapeHtml(url);
    const localPreview = url ? previewUrlByHosted.get(url) : null;
    const pano = is360ForPin(pin);

    // What can we show?
    const imgSrc = localPreview || (url ? url : "");

    let note = "";
    if (!imgSrc) {
      note = `<div class="popup-note">No preview available.</div>`;
    } else if (!localPreview) {
      note = `<div class="popup-note">Hosted preview. If you see 404, confirm the file exists at <b>${safeUrl}</b> in your repo.</div>`;
    } else {
      note = `<div class="popup-note">Local preview (this session). Hosted URL: <b>${safeUrl}</b></div>`;
    }

    const imgHtml = imgSrc ? `<img class="popup-img" src="${escapeHtml(imgSrc)}" alt="${title}">` : "";
    const actions = `
      <div class="popup-actions">
        ${pano && imgSrc ? `<a href="#" data-action="open360" data-url="${escapeHtml(url)}" data-title="${title}">Open 360 viewer (new tab)</a>` : ""}
        ${imgSrc ? `<a href="#" data-action="openraw" data-url="${escapeHtml(imgSrc)}">Open raw image</a>` : ""}
        <a href="#" data-action="edit" data-id="${escapeHtml(pin.id)}">Edit location</a>
      </div>
    `;

    return `
      <div class="popup-title">${title}</div>
      ${note}
      ${imgHtml}
      ${pano ? `<div class="popup-note">Detected/marked as 360 panorama.</div>` : ``}
      ${actions}
    `;
  }

  // -------------------------
  // Markers
  // -------------------------
  function removeAllMarkers() {
    for (const m of markerById.values()) m.remove();
    markerById.clear();
  }

  function addOrUpdateMarker(pin) {
    const popupHtml = buildPopupHtml(pin);
    const existing = markerById.get(pin.id);
    if (existing) {
      existing.setLatLng([pin.lat, pin.lng]);
      existing.setPopupContent(popupHtml);
      return existing;
    }
    const marker = L.marker([pin.lat, pin.lng]).addTo(map).bindPopup(popupHtml);
    markerById.set(pin.id, marker);
    return marker;
  }

  function renderAllPins(fit = false) {
    removeAllMarkers();
    for (const p of pinData) {
      if (!p || typeof p.lat !== "number" || typeof p.lng !== "number") continue;
      addOrUpdateMarker(p);
    }
    statusEl.textContent = pinData.length ? `${pinData.length} pin(s) loaded` : "No pins loaded yet";
    if (fit && pinData.length) {
      const group = L.featureGroup([...markerById.values()]);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  }

  // -------------------------
  // Manual queue (no GPS) – automatic flow
  // -------------------------
  function startManualQueue(queueDrafts) {
    manualQueue = queueDrafts.slice();
    if (!manualQueue.length) {
      mode = null;
      return;
    }
    const next = manualQueue.shift();
    mode = { type: "place-new", draft: next };
    statusEl.textContent = `No GPS: click map to place "${next.fileName}" (${manualQueue.length + 1} remaining)`;
  }

  function continueManualQueue() {
    if (!manualQueue.length) {
      mode = null;
      statusEl.textContent = "Manual placement complete.";
      return;
    }
    const next = manualQueue.shift();
    mode = { type: "place-new", draft: next };
    statusEl.textContent = `No GPS: click map to place "${next.fileName}" (${manualQueue.length + 1} remaining)`;
  }

  // -------------------------
  // 360 viewer open (NEW TAB)
  // Strategy:
  // - If hosted URL exists, open viewer with ?url=hostedUrl
  // - If we have a local blob for that hostedUrl, we also postMessage it to viewer tab
  // -------------------------
  function open360NewTab(hostedUrl, title) {
    const url = hostedUrl || "";
    const viewerUrl = `index.html#viewer?title=${encodeURIComponent(title || "360 Viewer")}&url=${encodeURIComponent(url)}`;
    const win = window.open(viewerUrl, "_blank", "noopener");
    if (!win) {
      alert("Popup blocked. Please allow popups for this site.");
      return;
    }

    // If we have a local preview blob, send that for instant viewing even if hosted 404
    const blob = hostedUrl ? previewUrlByHosted.get(hostedUrl) : null;
    if (blob) {
      // send a few times (tab may not be ready yet)
      let tries = 0;
      const timer = setInterval(() => {
        tries++;
        try {
          win.postMessage({ type: "PANO_URL", url: blob, title: title || "360 Viewer" }, "*");
        } catch {}
        if (tries >= 10) clearInterval(timer);
      }, 200);
    }
  }

  // -------------------------
  // Single global click handler (fixes “3 tabs” bug)
  // -------------------------
  document.addEventListener("click", (evt) => {
    const el = evt.target.closest?.("[data-action]");
    if (!el) return;

    const action = el.getAttribute("data-action");
    if (action === "open360") {
      evt.preventDefault();
      evt.stopPropagation();
      const hostedUrl = el.getAttribute("data-url"); // this should be photos/<file> or full url
      const title = el.getAttribute("data-title") || "360 Photo";
      open360NewTab(hostedUrl, title);
      return;
    }

    if (action === "openraw") {
      evt.preventDefault();
      evt.stopPropagation();
      const u = el.getAttribute("data-url");
      if (u) window.open(u, "_blank", "noopener");
      return;
    }

    if (action === "edit") {
      evt.preventDefault();
      evt.stopPropagation();
      const id = el.getAttribute("data-id");
      if (!id) return;
      manualQueue = [];
      mode = { type: "edit", pinId: id };
      statusEl.textContent = "Click map to set new location… (ESC to cancel)";
      return;
    }
  });

  // ESC cancels
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      manualQueue = [];
      mode = null;
      statusEl.textContent = "Cancelled.";
    }
  });

  // Map click places pin
  map.on("click", (evt) => {
    if (!mode) return;
    const { lat, lng } = evt.latlng;

    if (mode.type === "place-new") {
      const d = mode.draft;
      if (!d || !d.url) { mode = null; return; }
      const pin = {
        id: uid(),
        lat, lng,
        url: d.url,
        title: d.title || "",
        fileName: d.fileName || "",
        is360: d.is360 === true,
        ts: Date.now()
      };
      pinData.push(pin);
      saveLocal();
      renderAllPins(false);
      markerById.get(pin.id)?.openPopup();
      mode = null;
      map.setView([lat, lng], Math.max(map.getZoom(), 18));
      if (manualQueue.length) continueManualQueue();
      return;
    }

    if (mode.type === "edit") {
      const idx = pinData.findIndex(p => p.id === mode.pinId);
      if (idx < 0) { mode = null; return; }
      pinData[idx].lat = lat;
      pinData[idx].lng = lng;
      saveLocal();
      renderAllPins(false);
      markerById.get(pinData[idx].id)?.openPopup();
      mode = null;
      map.setView([lat, lng], Math.max(map.getZoom(), 18));
      return;
    }
  });

  // -------------------------
  // Load pins.json (repo) with fallback to local
  // -------------------------
  async function loadFromPinsJson() {
    try {
      const res = await fetch(PINS_JSON_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("pins.json not found");
      const arr = await res.json();
      if (!Array.isArray(arr)) throw new Error("pins.json invalid");

      pinData = arr
        .filter(p => p && typeof p.lat === "number" && typeof p.lng === "number" && p.url)
        .map(p => ({
          id: String(p.id || uid()),
          lat: p.lat,
          lng: p.lng,
          url: String(p.url),
          title: p.title ? String(p.title) : "",
          fileName: p.fileName ? String(p.fileName) : (String(p.url).split("/").pop() || ""),
          is360: p.is360 === true,
          ts: p.ts || Date.now()
        }));

      saveLocal();
      renderAllPins(true);
      statusEl.textContent = `${pinData.length} pin(s) loaded`;
    } catch (e) {
      const ok = loadLocal();
      renderAllPins(true);
      statusEl.textContent = ok ? `${pinData.length} pin(s) loaded (local)` : "No pins loaded yet";
    }
  }

  // -------------------------
  // Buttons
  // -------------------------
  reloadPinsBtn.addEventListener("click", async () => {
    await loadFromPinsJson();
  });

  exportPinsBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(pinData, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pins.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  importPinsBtn.addEventListener("click", () => importInput.click());
  importInput.addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    try {
      const txt = await f.text();
      const arr = JSON.parse(txt);
      if (!Array.isArray(arr)) throw new Error("Invalid");
      pinData = arr
        .filter(p => p && typeof p.lat === "number" && typeof p.lng === "number" && p.url)
        .map(p => ({
          id: String(p.id || uid()),
          lat: p.lat,
          lng: p.lng,
          url: String(p.url),
          title: p.title ? String(p.title) : "",
          fileName: p.fileName ? String(p.fileName) : (String(p.url).split("/").pop() || ""),
          is360: p.is360 === true,
          ts: p.ts || Date.now()
        }));
      saveLocal();
      renderAllPins(true);
      statusEl.textContent = `Imported ${pinData.length} pin(s)`;
    } catch {
      alert("Could not import JSON.");
    } finally {
      importInput.value = "";
    }
  });

  clearLocalBtn.addEventListener("click", () => {
    if (!confirm("Clear local pins + session previews?")) return;
    clearSessionPreviews();
    pinData = [];
    saveLocal();
    renderAllPins(false);
    mode = null;
    manualQueue = [];
    fileInput.value = "";
    statusEl.textContent = "No pins loaded yet";
  });

  // -------------------------
  // Author mode: Choose Files
  // - GPS => auto-pin
  // - No GPS => automatic queue (click map to place)
  // - Preview works immediately (session blob)
  // - Pin URL is set to photos/<filename> (so it will work once you upload photos to repo)
  // -------------------------
  fileInput.addEventListener("change", async (event) => {
    const files = Array.from(event.target.files || []);
    if (!files.length) return;

    // Keep previews for this session (do NOT clear, so older ones still preview)
    let addedGps = 0;
    const noGpsDrafts = [];

    // Build blob previews + pano detection first
    for (const file of files) {
      const hostedUrl = normalizeToHostedUrl(file.name); // photos/<filename>
      const blobUrl = URL.createObjectURL(file);
      sessionObjectUrls.push(blobUrl);
      previewUrlByHosted.set(hostedUrl, blobUrl);

      // pano detection from blob
      const pano = await detectPanorama(blobUrl);
      isPanoByHosted.set(hostedUrl, pano);
    }

    // GPS read + create pins
    for (const file of files) {
      const hostedUrl = normalizeToHostedUrl(file.name);
      const pano = isPanoByHosted.get(hostedUrl) === true;

      try {
        const gps = await exifr.gps(file);
        if (gps && typeof gps.latitude === "number" && typeof gps.longitude === "number") {
          pinData.push({
            id: uid(),
            lat: gps.latitude,
            lng: gps.longitude,
            url: hostedUrl,
            title: file.name,
            fileName: file.name,
            is360: pano,
            ts: Date.now()
          });
          addedGps++;
        } else {
          noGpsDrafts.push({ url: hostedUrl, title: file.name, fileName: file.name, is360: pano });
        }
      } catch {
        noGpsDrafts.push({ url: hostedUrl, title: file.name, fileName: file.name, is360: pano });
      }
    }

    saveLocal();
    renderAllPins(true);

    if (addedGps) {
      statusEl.textContent = `${addedGps} photo(s) pinned from GPS`;
    }

    if (noGpsDrafts.length) {
      // AUTOMATIC flow you asked for:
      // after choosing files, it immediately asks you to click map to place first no-GPS photo,
      // then continues until done.
      startManualQueue(noGpsDrafts);

      // Also show one alert so you notice it
      alert(`${noGpsDrafts.length} file(s) had no GPS. Click the map to place each one (you’ll be prompted in order).`);
    }
  });

  // -------------------------
  // Init
  // -------------------------
  (async () => {
    mode = null;
    manualQueue = [];
    await loadFromPinsJson();
  })();

})();
</script>
</body>
</html>
